stages:
  - lint
  - test

variables:
  GIT_SUBMODULE_STRATEGY: "recursive"

workflow:
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'
    - if: '$CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "master"'

fmt:
  image: "rust:latest"
  stage: lint
  script:
    - rustup component add rustfmt
    - cargo fmt -- --check

cargo-test:
  image: "rust:latest"
  stage: test
  script:
    - apt update && apt install -y fuse3 libfuse3-dev
    - cargo test --locked

exec-test:
  image: "redoxos/redoxer:latest"
  stage: test
  script:
    - cargo install --path . --locked
    - redoxer exec true

uefi-test:
  image: "redoxos/redoxer:aarch64"
  stage: test
  script:
    - cargo install --path . --locked
    - cd example && redoxer test
